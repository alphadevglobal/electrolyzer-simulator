name: Deploy AWS Lambda

on:
  push:
    branches: [ main ]
    paths:
      - 'projeto_ia_av3/deploy/**'
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy to AWS Lambda
    runs-on: ubuntu-latest

    steps:
    - name: Verificar secrets da AWS
      id: check_aws_secrets
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
          echo "ready=false" >> "$GITHUB_OUTPUT"
          echo "AWS_ACCESS_KEY_ID e AWS_SECRET_ACCESS_KEY não foram configurados. Configure-os para habilitar o deploy." >> $GITHUB_STEP_SUMMARY
        else
          echo "ready=true" >> "$GITHUB_OUTPUT"
        fi

    - name: Checkout código
      uses: actions/checkout@v3
      if: steps.check_aws_secrets.outputs.ready == 'true'

    - name: Setup Node.js
      uses: actions/setup-node@v3
      if: steps.check_aws_secrets.outputs.ready == 'true'
      with:
        node-version: '18'

    - name: Setup Python
      uses: actions/setup-python@v4
      if: steps.check_aws_secrets.outputs.ready == 'true'
      with:
        python-version: '3.10'

    - name: Configurar AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      if: steps.check_aws_secrets.outputs.ready == 'true'
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Instalar Serverless Framework
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: npm install -g serverless

    - name: Instalar dependências do projeto
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: |
        cd projeto_ia_av3/deploy
        npm install

    - name: Deploy para AWS Lambda
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: |
        cd projeto_ia_av3/deploy
        serverless deploy --stage prod --verbose

    - name: Obter URL da API
      id: get-url
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: |
        cd projeto_ia_av3/deploy
        API_URL=$(serverless info --stage prod | grep "POST" | awk '{print $3}')
        echo "API_URL=$API_URL" >> $GITHUB_OUTPUT

    - name: Testar Health Check
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: |
        sleep 10
        curl -f ${{ steps.get-url.outputs.API_URL }}/health || exit 1

    - name: Testar Endpoint de Predição
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: |
        curl -X POST ${{ steps.get-url.outputs.API_URL }}/predict \
          -H "Content-Type: application/json" \
          -d '{"features": [0.5, 0.3, 0.8, 0.2, 0.6, 0.4, 0.7, 0.1, 0.9, 0.5, 0.3, 0.8, 0.2, 0.6, 0.4, 0.7, 0.1, 0.9, 0.5, 0.3, 0.8, 0.2, 0.6, 0.4, 0.7, 0.1, 0.9, 0.5], "model": "mlp"}' \
          || exit 1

    - name: Criar resumo do deploy
      if: steps.check_aws_secrets.outputs.ready == 'true'
      run: |
        echo "## Deploy Concluído" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### API URL" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.get-url.outputs.API_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Endpoints Disponíveis" >> $GITHUB_STEP_SUMMARY
        echo "-  Health: \`GET /health\`" >> $GITHUB_STEP_SUMMARY
        echo "-  Predict: \`POST /predict\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Próximos Passos" >> $GITHUB_STEP_SUMMARY
        echo "1. Atualizar URL no frontend React" >> $GITHUB_STEP_SUMMARY
        echo "2. Fazer upload dos modelos treinados para S3" >> $GITHUB_STEP_SUMMARY
        echo "3. Configurar monitoramento no CloudWatch" >> $GITHUB_STEP_SUMMARY

    - name: Notificar sucesso
      if: success()
      run: |
        echo "Deploy para AWS Lambda concluído com sucesso."
        echo "API URL: ${{ steps.get-url.outputs.API_URL }}"

    - name: Notificar falha
      if: failure()
      run: |
        echo "Deploy falhou. Verifique os logs acima."
        exit 1

    - name: Aviso ausência secrets
      if: steps.check_aws_secrets.outputs.ready != 'true'
      run: echo "Deploy não executado por ausência de secrets da AWS."
